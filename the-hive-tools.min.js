// ==UserScript==
// @name         the-hive-tools
// @namespace    http://tampermonkey.net/
// @version      0.3.1
// @description  add some little features to The Hive forum
// @author       EifelDriver
// @match        https://www.enter-the-hive.de/forum/*
// @update       https://raw.githubusercontent.com/eifeldriver/the-hive-tools/master/the-hive-tools.min.js?v=0.3.1
// @grant        none
// ==/UserScript==
(function(){"use strict";var js_name="the-hive-tools";var js_version="0.3.1";var js_debug=1;var watcher1,watcher2;var cfg={};var cfg_options={highlight_friends:{type:"bool",label:"Freunde hervorheben",val:1},color_friend_bg:{type:"color",label:"Freund on Hintergrund",val:"#ffff00"},color_friend_fg:{type:"color",label:"Freund on Vordergrund",val:"#333333"},friends_list:{type:"list",label:"Freundesliste",val:[]},version:{type:"readonly",label:"Version",val:"?"}};var context_menu={user:{open:'<dt data-tht_menu="user" data-tht_task="open">open</dt>',add:'<dt data-tht_menu="user" data-tht_task="add">addToWatchlist</dt>',remove:'<dt data-tht_menu="user" data-tht_task="remove">removeFromWatchlist</dt>',activities:'<dt data-tht_menu="user" data-tht_task="activities">show activities</dt>'}};var thtMenu={user:{open:thtMenu_gotoUserProfile,add:thtMenu_addUserToWatchlist,remove:thtMenu_removeUserFromWatchlist,activities:thMenu_gotoUserActivities}};if(true){var dialog_css=""+"#tht-dialog { position: fixed; z-index: 99999; background: #666; color: #ccc; border: 1px solid #ccc; }"+"#tht-dialog .inner { } "+"#tht-dialog dl { } "+"#tht-dialog dt { color: #ccc; padding: 2px 5px; } "+"#tht-dialog dt:hover { background: #ccc; color: #666; cursor: pointer; } "+"#tht-dialog dt:active { background: #fff; color: #333; cursor: progress; } "+" ";var css=dialog_css+"#my-users-online li .tht-highlight { color: #fff !important; border: 1px solid #fff !important; padding: 2px 5px !important; display:inline-block; margin: 3px; }"+"#my-users-absent li { height: 2em; } "+"#my-users-absent li a {  } "+"#my-users-absent li span { display: block; width: 100%; position: relative; top: -1.5em; text-align: right; } "+""}function _debug(txt){if(js_debug){var d=new Date;var now=[d.getHours(),d.getMinutes(),d.getSeconds(),d.getMilliseconds()].join(":");console.log(now+": "+txt)}}function insertCss(css,css_id){var style=document.createElement("STYLE");if(css_id){style.id=css_id}style.innerHTML=css;document.querySelector("head").appendChild(style)}function updateCss(css,css_id){var styles=document.querySelector("#"+css_id);if(styles){styles.parentNode.removeChild(styles)}insertCss(css,css_id)}function getCurrentContext(){var context="";switch(document.querySelector("body").id){case"tpl_wbb_boardList":context="frontpage";break;case"tpl_wcf_team":context="all_members";break;case"tpl_wcf_membersList":context="memberlist";break}return context}function getClickedContext(e){var context="";var target=e.target;if(target.className.indexOf("userLink")!==-1||target.closest("a.userLink")){context="user"}return context}function readDataFromUrl(url,callback){var success=false;if(window.XMLHttpRequest){var xhr=new XMLHttpRequest;xhr.onload=callback;xhr.open("GET",url);xhr.send();success=true}return success}function setDataToCache(key,data){if(key&&data&&typeof key=="string"&&typeof data=="string"){var cache_data={data:data,timestamp:Date.now()};localStorage.setItem(js_name+"_cache_"+key,JSON.stringify(cache_data))}}function getDataFromCache(key,expire){var data=null;if(typeof expire!="number"){expire=60*60*24}if(key&&typeof key=="string"){try{var cache_data=JSON.parse(localStorage.getItem(js_name+"_cache_"+key));if(cache_data===null){_debug("error : key doesnt exist in cache")}else{if(Date.now()-cache_data.timestamp<expire){data=cache_data.data;_debug('cached data for "'+key+'" loaded')}else{_debug('cached data for "'+key+'" has expired')}}}catch(err){_debug("error: cached data isnt a JSON string")}}return data}function saveConfig(data){var success=false;if(typeof data=="object"){localStorage.setItem(js_name,JSON.stringify(data));success=true;_debug("cfg saved")}return success}function loadConfig(){var data;try{data=JSON.parse(localStorage.getItem(js_name));if(data===null){throw"cfg loading error"}_debug("cfg loaded");for(var property in cfg_options){if(!data.hasOwnProperty(property)){data[property]=cfg_options[property]["val"];_debug("add config option : "+property)}}_debug("cfg verified")}catch(err){data={};for(var property in cfg_options){data[property]=cfg_options[property]["val"]}_debug("cfg loading failed - use default settings")}cfg=data;saveConfig(cfg)}function thtMenu_gotoUserProfile(e){var dialog=e.target.closest("#tht-dialog");if(dialog){var infos=getTargetInfosFromDialog();location.href=infos.url;removeDialog()}}function thtMenu_addUserToWatchlist(e){var dialog=e.target.closest("#tht-dialog");if(dialog){var infos=getTargetInfosFromDialog();var user_name=infos.innerText;if(cfg){if(cfg.friends_list.indexOf(user_name)==-1){cfg.friends_list.push(user_name);saveConfig(cfg)}}removeDialog();location.href=location.href}}function thtMenu_removeUserFromWatchlist(e){var dialog=e.target.closest("#tht-dialog");if(dialog){var infos=getTargetInfosFromDialog();var user_name=infos.innerText;if(cfg){var idx=cfg.friends_list.indexOf(user_name);if(idx!==-1){delete cfg.friends_list[idx];saveConfig(cfg)}}removeDialog();location.href=location.href}}function thMenu_gotoUserActivities(e){var dialog=e.target.closest("#tht-dialog");if(dialog){var infos=getTargetInfosFromDialog();location.href=infos.url+"i/#recentActivity";removeDialog()}}function openDialog(menu_type,e){removeDialog();var context=getClickedContext(e);var wrapper=document.createElement("div");wrapper.id="tht-dialog-wrapper";wrapper.innerHTML='<div id="tht-dialog"><div class="inner"><dl></dl></div></div>';document.querySelector("body").appendChild(wrapper);var dialog=document.querySelector("#tht-dialog");var infos=setTargetInfosToDialog(e.target);switch(context){case"user":dialog.style.top=e.y+"px";dialog.style.left=e.x+"px";addDialogOption(dialog,"user","open");if(isUserOnWatchlist(infos.innerText)){addDialogOption(dialog,"user","remove")}else{addDialogOption(dialog,"user","add")}addDialogOption(dialog,"user","activities");break}initDialogMenu(dialog);document.querySelector("body").addEventListener("click",function(e){var target=e.target;var dialog_click=target.closest("#tht-dialog-wrapper");if(!dialog_click){removeDialog()}},true)}function removeDialog(){var dialog=document.querySelector("#tht-dialog-wrapper");if(dialog){dialog.parentNode.removeChild(dialog)}}function setTargetInfosToDialog(target){var infos=null;var dialog=document.querySelector("#tht-dialog");if(dialog){if(target.tagName.toLowerCase()=="font"){target=target.parentNode}infos={url:target.href,innerText:target.innerText};dialog.dataset.target=JSON.stringify(infos)}return infos}function getTargetInfosFromDialog(){var infos=null;var dialog=document.querySelector("#tht-dialog");if(dialog){infos=JSON.parse(dialog.dataset.target)}return infos}function addDialogOption(dialog,menu_type,opt_name){if(dialog&&context_menu&&context_menu.hasOwnProperty(menu_type)&&typeof context_menu[menu_type]=="object"){dialog.querySelector("dl").innerHTML+=context_menu[menu_type][opt_name]}}function initDialogMenu(dialog){if(dialog&&typeof dialog=="object"){var items=dialog.querySelectorAll("dt[data-tht_task]");items.forEach(function(item){item.addEventListener("click",thtMenu[item.dataset.tht_menu][item.dataset.tht_task])})}}function addPortletUsersOnline(){var users=document.querySelector("section.box[data-box-identifier='com.woltlab.wcf.UsersOnline']");if(users){var sidebar=document.querySelector(".sidebar.boxesSidebarRight .boxContainer");if(sidebar){var box=document.createElement("SECTION");box.id="my-users-online";box.className="box";box.innerHTML=users.innerHTML;sidebar.prepend(box);makeFriendsSelectable("#my-users-online");highlightFriends("#my-users-online")}}}function makeFriendsSelectable(selector){var users=document.querySelectorAll(selector+" a.userLink");users.forEach(function(item){item.addEventListener("click",showUserDialog,false)})}function showUserDialog(e){if(e.button==0){e.preventDefault();e.stopPropagation();var elem=e.target;if(elem.tagName.toLowerCase()=="font"){elem=elem.parentNode}openDialog("user",e);return false}}function isUserOnWatchlist(user_name){var found=false;if(cfg){if(cfg.friends_list.indexOf(user_name)!==-1){found=true}}return found}function highlightFriends(selector){var users=document.querySelectorAll(selector+" a.userLink");users.forEach(function(item){if(isUserOnWatchlist(item.innerText)){var font=item.querySelector("font");if(!font){item.style.backgroundColor="#666666";item.style.color="#333 !important";item.className=item.className.replace(" tht-highlight","")+" tht-highlight"}else{var color=font.color;font.style.backgroundColor=color;font.className=font.className.replace(" tht-highlight","")+" tht-highlight"}}})}function addPortletUsersAbsent(){var data=getDataFromCache("user-absent");if(data===null){readDataFromUrl("https://www.enter-the-hive.de/forum/absent-members-list/",updateUsersAbsentPortlet);data=""}var html=""+'<h2 class="boxTitle"><a href="https://www.enter-the-hive.de/forum/absent-members-list/">Benutzer abwesend</a></h2>'+'<div class="boxContent"><ol>'+data.trim()+"</ol></div>"+"";var sidebar=document.querySelector(".sidebar.boxesSidebarRight .boxContainer");if(sidebar){var box=document.createElement("SECTION");box.id="my-users-absent";box.className="box";box.innerHTML=html;sidebar.insertBefore(box,document.querySelector("#my-users-online").nextSibling)}}function updateUsersAbsentPortlet(data){if(data&&this.status==200){var parser=new DOMParser;var dom=parser.parseFromString(data.currentTarget.response,"text/html");var users=[];var html="";dom.querySelectorAll("ol .containerHeadline H3 a").forEach(function(item,idx){users.push({name:item.innerText.trim(),url:item.href,absent:""})});dom.querySelectorAll(".details .commaSeparated").forEach(function(item,idx){var tmp=item.innerText.trim().split("\n");users[idx]["absent"]=tmp[2].trim().replace("abwesend bis","")});users.forEach(function(user){html+='<li><a href="'+user.url+'" title="gehe zum Benutzerprofil">'+user.name+"</a><span>"+user.absent+"</span></li>"});var list=document.querySelector("#my-users-absent .boxContent ol");list.innerHTML=html.trim();setDataToCache("user-absent",html)}}function startScript(){_debug("the-hive-tools started");loadConfig();updateCss(css);switch(getCurrentContext()){case"frontpage":addPortletUsersOnline();addPortletUsersAbsent();break;case"all_members":break}}startScript()})();